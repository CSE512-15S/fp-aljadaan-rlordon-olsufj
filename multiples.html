<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Data QUEST</title>
        <link href="css/bootstrap.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Open+Sans"/>
        <script type="text/javascript" src="d3/d3.js"></script>
        <script type="text/javascript" src="js/underscore.js"></script>
        <script src="http://d3js.org/queue.v1.min.js"></script>
        <script type="text/javascript" src="js/jquery.js"></script>
        <script type="text/javascript" src="js/bootstrap.js"></script>
    </head>
    <style type="text/css">
        
      body {
        width: 1800px;
        margin-left: auto;
        margin-right: auto;
        font-family: Open Sans,Verdana,Arial,sans-serif;
        font-size: 16px;
        background: #E8E8E8;
      }
        
      .btn-group {
        margin-left: 100px;
      }
        
      .label {
        font-family: Open Sans, sans-serif;
        fill: darkgray;
        font-size: 16px;
      }
        
      svg {
        border: solid 3px DimGray;
      }
        
      .CenterWrapper { 
        width: 1800px;
        margin-left: auto;
        margin-right: auto; 
      }
        
      h1,h2,h4 {
        font-family: Open Sans, sans-serif;
      }
        
      .main-svg {
        margin: 0px 5px 5px 5px;  
        display: inline;
        float: left;
        vertical-align: top;
        background: white;
      }
        
      .box {
        margin-bottom: 5px;  
        margin-right: 5px;  
        display: inline;
        vertical-align: top;
        background: white;
      }
        
      #main-buttons {
        width: 500px;
        margin-left: auto;
        margin-right: auto;
      }


    </style>
    <body>
        <script src="http://d3js.org/colorbrewer.v1.min.js"></script>
        
        <!-- Navigation -->
        <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
            <div class="container">
                <!-- Brand and toggle get grouped for better mobile display -->
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="index.html">Back</a>
                </div>
                <!-- Collect the nav links, forms, and other content for toggling -->

                <!-- /.navbar-collapse -->
            </div>
        </nav>
        
        <br><br><br>
        
        <div class="CenterWrapper">
            
            <div style="margin-bottom: 20px">
                <center><h1 style="font-size: 50px">Primary Care Patient Demographics</h1></center>
                <center><h4 style = "color:DimGray; font-size:20px">Electronic Health Record Data from the six largest NW clinics</h4></center>
            </div> 
            
            <div id="main-buttons" style="margin-bottom: 50px">
                <div class="btn-group" style= "width: 500px; margin-left: auto; margin-right: auto;" data-toggle="buttons">

                <label class="btn btn-primary active" id="Gender">
                  <input type="radio" name="options"> By Gender
                </label>

                <label class="btn btn-primary" id="Race">
                  <input type="radio" name="options"> By Race
                </label>

                <label class="btn btn-primary" id="Ethnicity">
                  <input type="radio" name="options"> By Ethnicity
                </label>

                <label class="btn btn-primary" id="Age_Group">
                  <input type="radio" name="options"> By Age
                </label>

                </div>
            </div>    
        </div>
        
        
        <script>
        d3.csv('data/donut.csv', function (error, data) {
            
        var m = 25,
        b = 20;
        bigb = 35;
        r = 150;
        var h = (r+m)*1.5;
        var w = 30;
        var bigw = w*2;
        var scale = 120;
        var bigScale = scale*2;
        
        for (var j = 0; j < data.length; j++) {
            if (data[j].Age <= 12) {
                data[j].Age_Group = "0-12";
              } else if (data[j].Age <= 18 && data[j].Age > 12) {
                data[j].Age_Group = "13-18";
              } else if (data[j].Age <= 25 && data[j].Age > 18) {
                data[j].Age_Group = "19-25";
              } else if (data[j].Age <= 45 && data[j].Age > 25) {
                data[j].Age_Group = "26-45";
              } else if (data[j].Age <= 64 && data[j].Age > 45) {
                data[j].Age_Group = "46-64";
              } else {
                data[j].Age_Group = "65+";
              }
        }
            
        genderColor = d3.scale.ordinal()
                        .range(["#4169e1", "#ff69b4"]);
            
        raceColor = d3.scale.ordinal()
                        .range(["#377eb8", "#e41a1c", "#4daf4a", "#999999", "#ff7f00", "#f781bf" ]);
            
        raceColor2 = d3.scale.ordinal()
                        .range(["#377eb8", "#e41a1c", "#4daf4a", "#999999", "#ff7f00", "#f781bf" ]);
            
        ethnicityColor = d3.scale.ordinal()
                        .range(["#54278f", "#006d2c", "#999999"]);
            
        ageColor = d3.scale.ordinal()
                        .range(["#66c2a5", "#fc8d62", "#8da0cb", "#e78ac3", "#a6d854", "#ffd92f" ]);
      
        var margin = {top: 8, right: 10, bottom: 2, left: 10};        
        var width = 1000, height = 1000;
        
        var clinics = [999,13,17,14,16,4,12]; // 999 is a dummy value
        var clinicSize = [15805,12169,8030,3626,3305,2300];
        var clinicNames = ["DUMMY","Clinic 13: (15,805)", "Clinic 17: (12,169)", "Clinic 14: (8,030)", "Clinic 16: (3,626)", "Clinic 4: (3,305)", "Clinic 12: (2,300)" ];
        var genderLabels = ["dummy","dummy","Male","Female"];
        var raceLabels = ["dummy","dummy","dummy","dummy","dummy","dummy","White", "Asian", "Black", "Undefined", "Indian", "Hawaiian"];
        var ethnicityLabels = ["dummy","dummy","dummy","Not Hispanic", "Hispanic", "Undefined"];
        var ageLabels = ["dummy","dummy","dummy","dummy","dummy","dummy","0-12", "13-18", "19-25", "26-45", "46-64", "65+"];

        var DataArray =[];
        var TotalArray = [];          
        var selection = "Gender";
            
        dataSetup();
        draw(selection);
            
        $( ".btn" ).click(function() { 
            selection = this.id;
            dataSetup();
            draw();
            //console.log(overallArray);
        });
            
        function overall(selection) {
            for (var j=0;j<data.length;j++) {
                var maleCount = 0;
                var femaleCount = 0;
                var asianCount = 0;
                var indianCount = 0;
                var blackCount = 0;
                var whiteCount = 0;
                var undCount = 0;
                var islandCount = 0;
                var age1 = 0; //(0-12)
                var age2 = 0; //(13-18)
                var age3 = 0; //(19-25)
                var age4 = 0; //(26-45)
                var age5 = 0; //(46-64)
                var age6 = 0; //(65+)
                var hispanic = 0;
                var notHispanic = 0;
                var refused = 0;
                var und = 0;
                var blank = 0;
                
                var Gtotal = 0;
                /* GENDER COUNTER */                
                for (var j=0;j<data.length;j++) {
                    if (data[j].Gender === "M") {
                        maleCount++; Gtotal++;   
                    } else if (data[j].Gender === "F") { femaleCount++; Gtotal++; }
                }
                gender_array = [maleCount/Gtotal, femaleCount/Gtotal];
                if (selection === "Gender") { 
                    return gender_array;
                }
                //console.log("clinic id: " + clinicID + "| males: " + maleCount + "| females: " + femaleCount);  
                
                var Rtotal = 0;
                /* RACE COUNTER */                
                for (var j=0;j<data.length;j++) {
                    if (data[j].Race === "Asian") {
                        asianCount++; Rtotal++; 
                    } else if (data[j].Race === "American Indian or Alaksa Native") { 
                        indianCount++; Rtotal++; 
                    } else if (data[j].Race === "Black") { 
                        blackCount++; Rtotal++; 
                    } else if (data[j].Race === "White") { 
                        whiteCount++; Rtotal++; 
                    } else if (data[j].Race === "Undefined") { 
                        undCount++; Rtotal++; 
                    } else if (data[j].Race === "Native Hawaiian or Other Pacific Islander") { 
                        islandCount++; Rtotal++; 
                    }
              
                }
                race_array = [whiteCount/Rtotal, asianCount/Rtotal, blackCount/Rtotal, undCount/Rtotal, indianCount/Rtotal, islandCount/Rtotal ];                   if (selection === "Race") {
                    return race_array;
                }
                
                var ageTotal = 0;
                /* AGE COUNTER */                
                for (var j=0;j<data.length;j++) {
                    if ((data[j].Age <= 12)) { age1++; ageTotal++; } 
                    else if ((data[j].Age > 12 && data[j].Age <=18)) { age2++; ageTotal++; }
                    else if ((data[j].Age > 18 && data[j].Age <=25)) { age3++; ageTotal++; }
                    else if ((data[j].Age > 25 && data[j].Age <=45)) { age4++; ageTotal++; }
                    else if ((data[j].Age > 45 && data[j].Age <=64)) { age5++; ageTotal++; }
                    else if ((data[j].Age >= 65)) { age6++; ageTotal++; }
                }
                age_array = [age1/ageTotal, age2/ageTotal, age3/ageTotal, age4/ageTotal, age5/ageTotal, age6/ageTotal]; 
                if (selection === "Age_Group") { 
                    return age_array;
                }
                
                var Etotal = 0;
                /* ETHNICITY COUNTER */                
                for (var j=0;j<data.length;j++) {
                    if (data[j].Ethnicity === "Hispanic or Latino") { hispanic++; Etotal++; } 
                    else if (data[j].Ethnicity === "Not Hispanic or Latino") { notHispanic++; Etotal++; }
                    else if (data[j].Ethnicity === "Refused to Report/Unreported") { und++; Etotal++; }
                    else if (data[j].Ethnicity === "Undefined") { und++; Etotal++; }
                    else if (data[j].Ethnicity === "") { und++; Etotal++; }
                }
                ethnicity_array = [hispanic/Etotal, notHispanic/Etotal, und/Etotal];
                if (selection === "Ethnicity") { 
                    return ethnicity_array;
                }
            }
        }
        
        function whatClinic(clinicID, selection) {
            
            for (var j=0;j<data.length;j++) {
                
                var maleCount = 0;
                var femaleCount = 0;
                var asianCount = 0;
                var indianCount = 0;
                var blackCount = 0;
                var whiteCount = 0;
                var undCount = 0;
                var islandCount = 0;
                var age1 = 0; //(0-12)
                var age2 = 0; //(13-18)
                var age3 = 0; //(19-25)
                var age4 = 0; //(26-45)
                var age5 = 0; //(46-64)
                var age6 = 0; //(65+)
                var hispanic = 0;
                var notHispanic = 0;
                var refused = 0;
                var und = 0;
                var blank = 0;
                
                var Gtotal = 0;
                /* GENDER COUNTER */                
                for (var j=0;j<data.length;j++) {
                    if (data[j].Gender === "M" && data[j].Clinic_ID === clinicID.toString()) {
                        maleCount++; Gtotal++;   
                    } else if (data[j].Gender === "F" && data[j].Clinic_ID === clinicID.toString()) { femaleCount++; Gtotal++; }
                }
                gender_array = [Gtotal, maleCount, femaleCount];
                if (selection === "Gender") { 
                    return gender_array;
                }
                //console.log("clinic id: " + clinicID + "| males: " + maleCount + "| females: " + femaleCount);  
                
                var Rtotal = 0;
                /* RACE COUNTER */                
                for (var j=0;j<data.length;j++) {
                    if (data[j].Race === "Asian" && data[j].Clinic_ID === clinicID.toString()) {
                        asianCount++; Rtotal++; 
                    } else if (data[j].Race === "American Indian or Alaksa Native" && data[j].Clinic_ID === clinicID.toString()) { 
                        indianCount++; Rtotal++; 
                    } else if (data[j].Race === "Black" && data[j].Clinic_ID === clinicID.toString()) { 
                        blackCount++; Rtotal++; 
                    } else if (data[j].Race === "White" && data[j].Clinic_ID === clinicID.toString()) { 
                        whiteCount++; Rtotal++; 
                    } else if (data[j].Race === "Undefined" && data[j].Clinic_ID === clinicID.toString()) { 
                        undCount++; Rtotal++; 
                    } else if (data[j].Race === "Native Hawaiian or Other Pacific Islander" && data[j].Clinic_ID === clinicID.toString()) { 
                        islandCount++; Rtotal++; 
                    }
              
                }
                race_array = [Rtotal, whiteCount, asianCount, blackCount, undCount, indianCount, islandCount ];                   if (selection === "Race") {
                    return race_array;
                }
                
                var ageTotal = 0;
                /* AGE COUNTER */                
                for (var j=0;j<data.length;j++) {
                    if ((data[j].Age <= 12) && data[j].Clinic_ID === clinicID.toString()) { age1++; ageTotal++; } 
                    else if ((data[j].Age > 12 && data[j].Age <=18) && data[j].Clinic_ID === clinicID.toString()) { age2++; ageTotal++; }
                    else if ((data[j].Age > 18 && data[j].Age <=25) && data[j].Clinic_ID === clinicID.toString()) { age3++; ageTotal++; }
                    else if ((data[j].Age > 25 && data[j].Age <=45) && data[j].Clinic_ID === clinicID.toString()) { age4++; ageTotal++; }
                    else if ((data[j].Age > 45 && data[j].Age <=64) && data[j].Clinic_ID === clinicID.toString()) { age5++; ageTotal++; }
                    else if ((data[j].Age >= 65) && data[j].Clinic_ID === clinicID.toString()) { age6++; ageTotal++; }
                }
                age_array = [ageTotal,age1, age2, age3, age4, age5, age6]; 
                if (selection === "Age_Group") { 
                    return age_array;
                }
                
                var Etotal = 0;
                /* ETHNICITY COUNTER */                
                for (var j=0;j<data.length;j++) {
                    if (data[j].Ethnicity === "Hispanic or Latino" && data[j].Clinic_ID === clinicID.toString()) { hispanic++; Etotal++; } 
                    else if (data[j].Ethnicity === "Not Hispanic or Latino" && data[j].Clinic_ID === clinicID.toString()) { notHispanic++; Etotal++; }
                    else if (data[j].Ethnicity === "Refused to Report/Unreported" && data[j].Clinic_ID === clinicID.toString()) { und++; Etotal++; }
                    else if (data[j].Ethnicity === "Undefined" && data[j].Clinic_ID === clinicID.toString()) { und++; Etotal++; }
                    else if (data[j].Ethnicity === "" && data[j].Clinic_ID === clinicID.toString()) { und++; Etotal++; }
                }
                ethnicity_array = [Etotal, hispanic, notHispanic, und];
                if (selection === "Ethnicity") { 
                    return ethnicity_array;
                }
            } 
        }
            
        var DataArray = [];
        var overallArray = [];
            
        function sum(input) {
            var countCategories = _.countBy(data, function (d) {
                if (input === "Gender") {
                    return d.Gender; 
                } else if (input === "Race") {
                    return d.Race;   
                } else if (input === "Ethnicity") {
                    return d.Ethnicity;   
                } else if (input === "Age_Group") {
                    return d.Age_Group;
                }
            });
            console.log(countCategories);
        }
            
        function dataSetup() {      
            DataArray = [];            
            overallArray = [];
            
            overallArray = overall(selection);
            
            for (var i=0;i<clinics.length;i++) {
                var tempDataArray = whatClinic(clinics[i], selection);
                DataArray.push(tempDataArray); 
            }
        }
        
        function draw() {
            var format = d3.format('.1f');            
            d3.selectAll("svg").remove();
            
            var svgMain = d3.select(".CenterWrapper").append("svg")
                            .attr("class", "main-svg")
                            .attr("width", (r+m) * 4)
                            .attr("height", h*2 + 5);
            
            if (selection === "Gender") {
                var l = 2;
                var start = (4*(r+m) - (bigw*l + bigb*(l-1)))/2;
                
                var rect = svgMain.selectAll("rect")
                            .data(overallArray)
                            .enter().append("rect")
                            .attr("class","test")
                            .attr("x", function(d,i) { return start + i*(bigw+bigb) })
                            .attr("y", function(d) { return (h*2+10-150)-0; })
                            .attr("width", bigw)
                            .attr("height", function(d) { return 0; })
                            .on("mouseover", function (d) { showPopover.call(this, d); })
                            .on("mouseout", function (d) { removePopovers(); })
                            .style("fill", genderColor );
                
                rect.transition().duration(1000)
                    .attr("y", function(d) { return (h*2+10-150)-d*bigScale; })
                    .attr("height", function(d) { return d*bigScale; });
                
                var labels = svgMain.selectAll("text")
                            .data(overallArray)
                            .enter().append("text")
                            .text(function(d) { return format( d * 100 ) + "%"; })
                            .attr("text-anchor", "middle")
                            .attr("x", function(d,i) { return start + bigw/2 + i*(bigw+bigb); })
                            .attr("y", function(d) { return (h*2+10-150)-0*bigScale - 5; })
                            .attr("fill", "black")
                            .attr("font-size", "18px");
                
                labels.transition().duration(1000).attr("y", function(d) { return (h*2+10-150)-d*bigScale - 5; }) 
                
                svgMain.selectAll("text")
                            .data(genderLabels)
                            .enter().append("text")
                            .text(function(d) { return d; })
                            .attr("text-anchor", "middle")
                            .attr("x", function(d,i) { return start + bigw/2 + (i-2)*(bigw+bigb); })
                            .attr("y", function(d) { return (h*2+10-150) + 20; })
                            .attr("fill", "DimGray")
                            .attr("font-size", "16px");
            
            } else if (selection === "Race") {
                var l = 6;
                var start = (4*(r+m) - (bigw*l + bigb*(l-1)))/2;
                
                var rect = svgMain.selectAll("rect")
                            .data(overallArray)
                            .enter().append("rect")
                            .attr("class","bar")
                            .attr("x", function(d,i) { return start + i*(bigw+bigb) })
                            .attr("y", function(d) { return (h*2+10-150)-0; })
                            .attr("width", bigw)
                            .attr("height", function(d) { return 0; })
                            .on("mouseover", function (d) { showPopover.call(this, d); })
                            .on("mouseout", function (d) { removePopovers(); })
                            .style("fill", raceColor2 );
                
                rect.transition().duration(1000)
                    .attr("y", function(d) { return (h*2+10-150)-d*bigScale; })
                    .attr("height", function(d) { return d*bigScale; });
                
                var labels = svgMain.selectAll("text")
                            .data(overallArray)
                            .enter().append("text")
                            .text(function(d) { return format( d * 100 ) + "%"; })
                            .attr("text-anchor", "middle")
                            .attr("x", function(d,i) { return start + bigw/2 + i*(bigw+bigb); })
                            .attr("y", function(d) { return (h*2+10-150)-0*bigScale - 5; })
                            .attr("fill", "black")
                            .attr("font-size", "18px");
                
                labels.transition().duration(1000).attr("y", function(d) { return (h*2+10-150)-d*bigScale - 5; }) 
                
                svgMain.selectAll("text")
                            .data(raceLabels)
                            .enter().append("text")
                            .text(function(d) { return d; })
                            .attr("text-anchor", "middle")
                            .attr("x", function(d,i) { return start + bigw/2 + (i-6)*(bigw+bigb); })
                            .attr("y", function(d) { return (h*2+10-150) + 20; })
                            .attr("fill", "DimGray")
                            .attr("font-size", "16px");
                
            } else if (selection === "Ethnicity") {
                 var l = 3;
                 var start = (4*(r+m) - (bigw*l + bigb*(l-1)))/2;
            
                 var rect = svgMain.selectAll("rect")
                            .data(overallArray)
                            .enter().append("rect")
                            .attr("class","bar")
                            .attr("x", function(d,i) { return start + i*(bigw+bigb) })
                            .attr("y", function(d) { return (h*2+10-150)-0; })
                            .attr("width", bigw)
                            .attr("height", function(d) { return 0; })
                            .on("mouseover", function (d) { showPopover.call(this, d); })
                            .on("mouseout", function (d) { removePopovers(); })
                            .style("fill", ethnicityColor );
                
                rect.transition().duration(1000)
                    .attr("y", function(d) { return (h*2+10-150)-d*bigScale; })
                    .attr("height", function(d) { return d*bigScale; });
                
                var labels = svgMain.selectAll("text")
                            .data(overallArray)
                            .enter().append("text")
                            .text(function(d) { return format( d * 100 ) + "%"; })
                            .attr("text-anchor", "middle")
                            .attr("x", function(d,i) { return start + bigw/2 + i*(bigw+bigb); })
                            .attr("y", function(d) { return (h*2+10-150)-0*bigScale - 5; })
                            .attr("fill", "black")
                            .attr("font-size", "18px");
                
                labels.transition().duration(1000).attr("y", function(d) { return (h*2+10-150)-d*bigScale - 5; }) 
                
                svgMain.selectAll("text")
                            .data(ethnicityLabels)
                            .enter().append("text")
                            .text(function(d) { return d; })
                            .attr("text-anchor", "middle")
                            .attr("x", function(d,i) { return start + bigw/2 + (i-3)*(bigw+bigb); })
                            .attr("y", function(d) { return (h*2+10-150) + 20; })
                            .attr("fill", "DimGray")
                            .attr("font-size", "16px");
                
                
            } else if (selection === "Age_Group") {
                var l = 6;
                var start = (4*(r+m) - (bigw*l + bigb*(l-1)))/2;
                
                var rect = svgMain.selectAll("rect")
                            .data(overallArray)
                            .enter().append("rect")
                            .attr("class","bar")
                            .attr("x", function(d,i) { return start + i*(bigw+bigb) })
                            .attr("y", function(d) { return (h*2+10-150)-0; })
                            .attr("width", bigw)
                            .attr("height", function(d) { return 0; })
                            .on("mouseover", function (d) { showPopover.call(this, d); })
                            .on("mouseout", function (d) { removePopovers(); })
                            .style("fill", ageColor );
                
                rect.transition().duration(1000)
                    .attr("y", function(d) { return (h*2+10-150)-d*bigScale; })
                    .attr("height", function(d) { return d*bigScale; });
                
                
                var labels = svgMain.selectAll("text")
                            .data(overallArray)
                            .enter().append("text")
                            .text(function(d) { return format( d * 100 ) + "%"; })
                            .attr("text-anchor", "middle")
                            .attr("x", function(d,i) { return start + bigw/2 + i*(bigw+bigb); })
                            .attr("y", function(d) { return (h*2+10-150)- 0*bigScale - 5; })
                            .attr("fill", "black")
                            .attr("font-size", "18px");
                
                labels.transition().duration(1000).attr("y", function(d) { return (h*2+10-150)-d*bigScale - 5; })    
                
                svgMain.selectAll("text")
                            .data(ageLabels)
                            .enter().append("text")
                            .text(function(d) { return d; })
                            .attr("text-anchor", "middle")
                            .attr("x", function(d,i) { return start + bigw/2 + (i-6)*(bigw+bigb); })
                            .attr("y", function(d) { return (h*2+10-150) + 20; })
                            .attr("fill", "DimGray")
                            .attr("font-size", "16px");
                
            }
            
            
            svgMain.append("text").attr("text-anchor", "middle").attr("font-size", "22px")
                                  .attr("font-family", "Open Sans")
                                  .attr("x", (r+m)*2).attr("y", 30)
                                  .text("Total: (45,235)");            
            

            var svg = d3.select(".CenterWrapper").selectAll("svg")
                .data(DataArray)
                .enter().append("svg:svg")
                .attr("class","box")
                .attr("width", (r + m) * 2)
                .attr("height", h)
                .append("svg:g")
                .attr("transform", "translate(" + (r + m) + "," + (r + m) + ")")
                .each(multiple)  

            svg
                .data(clinicNames)
                .each(multLabels)  
    
        }
            
            
        function multLabels() {
            var svg = d3.select(this);
            
            var ClinicLabel = svg.append("text")
                                 .attr("x", 0)
                                 .attr("y", -(r))
                                 .attr("text-anchor", "middle")
                                 .attr("font-size", "20px")
                                 .attr("font-family","Open Sans")
                                 .text(function (d) { return d; });
            
        }   
       
        function multiple() {
              var svg = d3.select(this);
              var format = d3.format('.1f');

              if (selection === "Gender") {
                  var l = 2;
                  var start = (2*(r+m) - (w*l + b*(l-1)))/2;
                  start += -(r+m);
             
                  var bar1 = svg.append("rect")
                        .attr("class","bar")
                        .attr("x", function(d,i) { return start+i*(w+5) })
                        .attr("y", function(d) { return 0*scale; })
                        .attr("width", w)
                        .attr("height", function(d) { return 0*scale; })
                        .on("mouseover", function (d) { showPopoverSM.call(this, d, 1); })
                        .on("mouseout", function (d) { removePopovers(); })
                        .style("fill", genderColor(0));
                  
                  bar1.transition().duration(1000)
                        .attr("y", function(d) { return -(d[1]/d[0])*scale; })
                        .attr("height", function(d) { return (d[1]/d[0])*scale; });
                  
                  var labels1 = svg
                     .append("text")
                     .text(function(d) { return format( (d[1]/d[0]) * 100 ) + "%"; })
                     .attr("text-anchor", "middle")
                     .attr("x", start + w/2)
                     .attr("y", function(d) { return 0 - 5; })
                     .attr("fill", "black")
                     .attr("font-size", "14px");
                  
                  labels1.transition().duration(1000).attr("y", function(d) { return -(d[1]/d[0])*scale - 5; })
                  
                  svg
                    .append("text")
                    .text(function(d) { return "Male"; })
                    .attr("text-anchor", "middle")
                    .attr("x", start + w/2)
                    .attr("y", 20)
                    .attr("fill", "DimGray")
                    .attr("font-size", "14px");

                  var bar2 = svg.append("rect")
                        .attr("class","bar")
                        .attr("x", function(d,i) { return start+(w+b)+i*(w+5) })
                        .attr("y", function(d) { return 0*scale; })
                        .attr("width", w)
                        .attr("height", function(d) { return 0*scale; })
                        .on("mouseover", function (d) { showPopoverSM.call(this, d, 2); })
                        .on("mouseout", function (d) { removePopovers(); })
                        .attr("height", function(d) { return 0*scale; })
                        .style("fill", genderColor(1));
                  
                  bar2.transition().duration(1000)
                        .attr("y", function(d) { return -(d[2]/d[0])*scale; })
                        .attr("height", function(d) { return (d[2]/d[0])*scale; });
                  
                  var labels2 = svg
                     .append("text")
                     .text(function(d) { return format( (d[2]/d[0]) * 100 ) + "%"; })
                     .attr("text-anchor", "middle")
                     .attr("x", start+(w+b) + w/2)
                     .attr("y", function(d) { return 0 - 5; })
                     .attr("fill", "black")
                     .attr("font-size", "14px");
                  
                  labels2.transition().duration(1000).attr("y", function(d) { return -(d[2]/d[0])*scale - 5; })
                  
                  svg
                    .append("text")
                    .text(function(d) { return "Female"; })
                    .attr("text-anchor", "middle")
                    .attr("x", start+(w+b) + w/2)
                    .attr("y", 20)
                    .attr("fill", "DimGray")
                    .attr("font-size", "14px");
                  
                  
              }
                
             if (selection === "Race") {
                 
                 var l = 6;
                 var start = (2*(r+m) - (w*l + b*(l-1)))/2;
                 start += -(r+m);
                 
                 var q = 15;
             
                var bar1 = svg.append("rect")
                        .attr("x", function(d,i) { return start+i*(w+5) })
                        .attr("y", function(d) { return 0*scale; })
                        .attr("width", w)
                        .on("mouseover", function (d) { showPopoverSM.call(this, d, 1); })
                        .on("mouseout", function (d) { removePopovers(); })
                        .attr("height", function(d) { return 0*scale; })
                        .style("fill", raceColor(0));
                 
                 bar1.transition().duration(1000)
                        .attr("y", function(d) { return -(d[1]/d[0])*scale; })
                        .attr("height", function(d) { return (d[1]/d[0])*scale; });
                 
                 var labels1 = svg
                     .append("text")
                     .text(function(d) { return format( (d[1]/d[0]) * 100 ) + "%"; })
                     .attr("text-anchor", "middle")
                     .attr("x",start + w/2)
                     .attr("y", function(d) { return 0-5 ; })
                     .attr("fill", "black")
                     .attr("font-size", "14px");
                 
                 labels1.transition().duration(1000).attr("y", function(d) { return -(d[1]/d[0])*scale - 5; })
                 
                 svg
                    .append("text")
                    .text(function(d) { return "White"; })
                    .attr("text-anchor", "end")
                    .attr("x", start + w/2)
                    .attr("y", q)
                    .attr("fill", "DimGray")
                    .attr("font-size", "14px")
                    .attr("transform", function(d) { return "rotate(-45 -125, 15)" });

                 var bar2 = svg.append("rect")
                        .attr("x", function(d,i) { return start+(w+b)+i*(w+5) })
                        .attr("y", function(d) { return 0*scale; })
                        .attr("width", w)
                        .on("mouseover", function (d) { showPopoverSM.call(this, d, 2); })
                        .on("mouseout", function (d) { removePopovers(); })
                        .attr("height", function(d) { return 0*scale; })
                        .style("fill", raceColor(1));
                 
                 bar2.transition().duration(1000)
                        .attr("y", function(d) { return -(d[2]/d[0])*scale; })
                        .attr("height", function(d) { return (d[2]/d[0])*scale; });
                 
                 var labels2 = svg
                     .append("text")
                     .text(function(d) { return format( (d[2]/d[0]) * 100 ) + "%"; })
                     .attr("text-anchor", "middle")
                     .attr("x", start+(w+b) + w/2)
                     .attr("y", function(d) { return 0-5; })
                     .attr("fill", "black")
                     .attr("font-size", "14px");
                 
                 labels2.transition().duration(1000).attr("y", function(d) { return -(d[2]/d[0])*scale - 5; })
                 
                 svg
                    .append("text")
                    .text(function(d) { return "Asian"; })
                    .attr("text-anchor", "end")
                    .attr("x", start+(w+b) + w/2)
                    .attr("y", q)
                    .attr("fill", "DimGray")
                    .attr("font-size", "14px")
                    .attr("transform", function(d) { return "rotate(-45 -75,15)" });

                 var bar3 = svg.append("rect")
                        .attr("x", function(d,i) { return start + (w+b)*2 +i*(w+5) })
                        .attr("y", function(d) { return 0*scale; })
                        .attr("width", w)
                        .on("mouseover", function (d) { showPopoverSM.call(this, d, 3); })
                        .on("mouseout", function (d) { removePopovers(); })
                        .attr("height", function(d) { return 0*scale; })
                        .style("fill", raceColor(2));
                 
                 bar3.transition().duration(1000)
                        .attr("y", function(d) { return -(d[3]/d[0])*scale; })
                        .attr("height", function(d) { return (d[3]/d[0])*scale; });
                 
                 var labels3 = svg
                     .append("text")
                     .text(function(d) { return format( (d[3]/d[0]) * 100 ) + "%"; })
                     .attr("text-anchor", "middle")
                     .attr("x",start + (w+b)*2 + w/2)
                     .attr("y", function(d) { return 0-5; })
                     .attr("fill", "black")
                     .attr("font-size", "14px");
                 
                 labels3.transition().duration(1000).attr("y", function(d) { return -(d[3]/d[0])*scale - 5; })
                 
                 svg
                    .append("text")
                    .text(function(d) { return "Black"; })
                    .attr("text-anchor", "end")
                    .attr("x", start + (w+b)*2 + w/2)
                    .attr("y", q)
                    .attr("fill", "DimGray")
                    .attr("font-size", "14px")
                    .attr("transform", function(d) { return "rotate(-45 -25, 15)" });

                 var bar4 = svg.append("rect")
                        .attr("x", function(d,i) { return start + (w+b)*3+i*(w+5) })
                        .attr("y", function(d) { return 0*scale; })
                        .attr("width", w)
                        .on("mouseover", function (d) { showPopoverSM.call(this, d, 4); })
                        .on("mouseout", function (d) { removePopovers(); })
                        .attr("height", function(d) { return 0*scale; })
                        .style("fill", raceColor(3));
                 
                 bar4.transition().duration(1000)
                        .attr("y", function(d) { return -(d[4]/d[0])*scale; })
                        .attr("height", function(d) { return (d[4]/d[0])*scale; });
                 
                 var labels4 = svg
                     .append("text")
                     .text(function(d) { return format( (d[4]/d[0]) * 100 ) + "%"; })
                     .attr("text-anchor", "middle")
                     .attr("x",start + (w+b)*3 + w/2)
                     .attr("y", function(d) { return 0-5; })
                     .attr("fill", "black")
                     .attr("font-size", "14px");
                 
                 labels4.transition().duration(1000).attr("y", function(d) { return -(d[4]/d[0])*scale - 5; })
                 
                 svg
                    .append("text")
                    .text(function(d) { return "Undefined"; })
                    .attr("text-anchor", "end")
                    .attr("x", start + (w+b)*3 + w/2)
                    .attr("y", q)
                    .attr("fill", "DimGray")
                    .attr("font-size", "14px")
                    .attr("transform", function(d) { return "rotate(-45 25, 15)" });
                 
                 var bar5 = svg.append("rect")
                        .attr("x", function(d,i) { return start + (w+b)*4+i*(w+5) })
                        .attr("y", function(d) { return 0*scale; })
                        .attr("width", w)
                        .on("mouseover", function (d) { showPopoverSM.call(this, d, 5); })
                        .on("mouseout", function (d) { removePopovers(); })
                        .attr("height", function(d) { return 0*scale; })
                        .style("fill", raceColor(4));
                 
                 bar5.transition().duration(1000)
                        .attr("y", function(d) { return -(d[5]/d[0])*scale; })
                        .attr("height", function(d) { return (d[5]/d[0])*scale; });
                 
                 var labels5 = svg
                     .append("text")
                     .text(function(d) { return format( (d[5]/d[0]) * 100 ) + "%"; })
                     .attr("text-anchor", "middle")
                     .attr("x", start + (w+b)*4 + w/2)
                     .attr("y", function(d) { return 0-5; })
                     .attr("fill", "black")
                     .attr("font-size", "14px");
                 
                 labels5.transition().duration(1000).attr("y", function(d) { return -(d[5]/d[0])*scale - 5; })
                 
                 svg
                    .append("text")
                    .text(function(d) { return "Indian"; })
                    .attr("text-anchor", "end")
                    .attr("x", start + (w+b)*4 + w/2)
                    .attr("y", q)
                    .attr("fill", "DimGray")
                    .attr("font-size", "14px")
                    .attr("transform", function(d) { return "rotate(-45 75, 15)" });
                 
                 var bar6 = svg.append("rect")
                        .attr("x", function(d,i) { return start + (w+b)*5+i*(w+5) })
                        .attr("y", function(d) { return 0*scale; })
                        .attr("width", w)
                        .on("mouseover", function (d) { showPopoverSM.call(this, d, 6); })
                        .on("mouseout", function (d) { removePopovers(); })
                        .attr("height", function(d) { return 0*scale; })
                        .style("fill", raceColor(5));
                 
                 bar6.transition().duration(1000)
                        .attr("y", function(d) { return -(d[6]/d[0])*scale; })
                        .attr("height", function(d) { return (d[6]/d[0])*scale; });
                 
                 var labels6 = svg
                     .append("text")
                     .text(function(d) { return format( (d[6]/d[0]) * 100 ) + "%"; })
                     .attr("text-anchor", "middle")
                     .attr("x", start + (w+b)*5 + w/2)
                     .attr("y", function(d) { return 0-5; })
                     .attr("fill", "black")
                     .attr("font-size", "14px");
                 
                 labels6.transition().duration(1000).attr("y", function(d) { return -(d[6]/d[0])*scale - 5; })
                 
                 svg
                    .append("text")
                    .text(function(d) { return "Hawaiian"; })
                    .attr("text-anchor", "end")
                    .attr("x", start + (w+b)*5 + w/2)
                    .attr("y", q)
                    .attr("fill", "DimGray")
                    .attr("font-size", "14px")
                    .attr("transform", function(d) { return "rotate(-45 125, 15)" });
            
            }
             
            if (selection === "Age_Group") {
                
                 var l = 6;
                 var start = (2*(r+m) - (w*l + b*(l-1)))/2;
                 start += -(r+m);
                
                 var bar1 = svg.append("rect")
                        .attr("x", function(d,i) { return start+i*(w+5) })
                        .attr("y", function(d) { return 0*scale; })
                        .attr("width", w)
                        .on("mouseover", function (d) { showPopoverSM.call(this, d, 1); })
                        .on("mouseout", function (d) { removePopovers(); })
                        .attr("height", function(d) { return 0*scale; })
                        .style("fill", ageColor(0));
                
                bar1.transition().duration(1000)
                        .attr("y", function(d) { return -(d[1]/d[0])*scale; })
                        .attr("height", function(d) { return (d[1]/d[0])*scale; });
                 
                var labels1 = svg
                     .append("text")
                     .text(function(d) { return format( (d[1]/d[0]) * 100 ) + "%"; })
                     .attr("text-anchor", "middle")
                     .attr("x",start + w/2)
                     .attr("y", function(d) { return 0-5; })
                     .attr("fill", "black")
                     .attr("font-size", "14px");
                
                labels1.transition().duration(1000).attr("y", function(d) { return -(d[1]/d[0])*scale - 5; })
                
                svg
                    .append("text")
                    .text(function(d) { return "0-12"; })
                    .attr("text-anchor", "middle")
                    .attr("x", start + w/2)
                    .attr("y", 20)
                    .attr("fill", "DimGray")
                    .attr("font-size", "14px")


                var bar2 = svg.append("rect")
                        .attr("x", function(d,i) { return start+(w+b)+i*(w+5) })
                        .attr("y", function(d) { return 0*scale; })
                        .attr("width", w)
                        .on("mouseover", function (d) { showPopoverSM.call(this, d, 2); })
                        .on("mouseout", function (d) { removePopovers(); })
                        .attr("height", function(d) { return 0*scale; })
                        .style("fill", ageColor(1));
                
                bar2.transition().duration(1000)
                        .attr("y", function(d) { return -(d[2]/d[0])*scale; })
                        .attr("height", function(d) { return (d[2]/d[0])*scale; });
                 
                var labels2 = svg
                     .append("text")
                     .text(function(d) { return format( (d[2]/d[0]) * 100 ) + "%"; })
                     .attr("text-anchor", "middle")
                     .attr("x", start+(w+b) + w/2)
                     .attr("y", function(d) { return 0-5; })
                     .attr("fill", "black")
                     .attr("font-size", "14px");
                
                labels2.transition().duration(1000).attr("y", function(d) { return -(d[2]/d[0])*scale - 5; })
                
                svg
                    .append("text")
                    .text(function(d) { return "13-18"; })
                    .attr("text-anchor", "middle")
                    .attr("x", start+(w+b) + w/2)
                    .attr("y", 20)
                    .attr("fill", "DimGray")
                    .attr("font-size", "14px")

                var bar3 = svg.append("rect")
                        .attr("x", function(d,i) { return start + (w+b)*2 +i*(w+5) })
                        .attr("y", function(d) { return 0*scale; })
                        .attr("width", w)
                        .on("mouseover", function (d) { showPopoverSM.call(this, d, 3); })
                        .on("mouseout", function (d) { removePopovers(); })
                        .attr("height", function(d) { return 0*scale; })
                        .style("fill", ageColor(2));
                
                bar3.transition().duration(1000)
                        .attr("y", function(d) { return -(d[3]/d[0])*scale; })
                        .attr("height", function(d) { return (d[3]/d[0])*scale; });
                 
                var labels3 = svg
                     .append("text")
                     .text(function(d) { return format( (d[3]/d[0]) * 100 ) + "%"; })
                     .attr("text-anchor", "middle")
                     .attr("x",start + (w+b)*2 + w/2)
                     .attr("y", function(d) { return 0-5; })
                     .attr("fill", "black")
                     .attr("font-size", "14px");
                
                labels3.transition().duration(1000).attr("y", function(d) { return -(d[3]/d[0])*scale - 5; })
                
                svg
                    .append("text")
                    .text(function(d) { return "19-25"; })
                    .attr("text-anchor", "middle")
                    .attr("x", start+(w+b)*2 + w/2)
                    .attr("y", 20)
                    .attr("fill", "DimGray")
                    .attr("font-size", "14px")

                var bar4 = svg.append("rect")
                        .attr("x", function(d,i) { return start + (w+b)*3+i*(w+5) })
                        .attr("y", function(d) { return 0*scale; })
                        .attr("width", w)
                        .on("mouseover", function (d) { showPopoverSM.call(this, d, 4); })
                        .on("mouseout", function (d) { removePopovers(); })
                        .attr("height", function(d) { return 0*scale; })
                        .style("fill", ageColor(3));
                
                bar4.transition().duration(1000)
                        .attr("y", function(d) { return -(d[4]/d[0])*scale; })
                        .attr("height", function(d) { return (d[4]/d[0])*scale; });
                 
                var labels4 = svg
                     .append("text")
                     .text(function(d) { return format( (d[4]/d[0]) * 100 ) + "%"; })
                     .attr("text-anchor", "middle")
                     .attr("x",start + (w+b)*3 + w/2)
                     .attr("y", function(d) { return 0-5; })
                     .attr("fill", "black")
                     .attr("font-size", "14px");
                
                labels4.transition().duration(1000).attr("y", function(d) { return -(d[4]/d[0])*scale - 5; })
                
                svg
                    .append("text")
                    .text(function(d) { return "26-45"; })
                    .attr("text-anchor", "middle")
                    .attr("x", start+(w+b)*3 + w/2)
                    .attr("y", 20)
                    .attr("fill", "DimGray")
                    .attr("font-size", "14px")
                 
                 var bar5 = svg.append("rect")
                        .attr("x", function(d,i) { return start + (w+b)*4+i*(w+5) })
                        .attr("y", function(d) { return 0*scale; })
                        .attr("width", w)
                        .on("mouseover", function (d) { showPopoverSM.call(this, d, 5); })
                        .on("mouseout", function (d) { removePopovers(); })
                        .attr("height", function(d) { return 0*scale; })
                        .style("fill", ageColor(4));
                
                bar5.transition().duration(1000)
                        .attr("y", function(d) { return -(d[5]/d[0])*scale; })
                        .attr("height", function(d) { return (d[5]/d[0])*scale; });
                 
                var labels5 = svg
                     .append("text")
                     .text(function(d) { return format( (d[5]/d[0]) * 100 ) + "%"; })
                     .attr("text-anchor", "middle")
                     .attr("x", start + (w+b)*4 + w/2)
                     .attr("y", function(d) { return 0-5; })
                     .attr("fill", "black")
                     .attr("font-size", "14px");
                
                labels5.transition().duration(1000).attr("y", function(d) { return -(d[5]/d[0])*scale - 5; })
                
                svg
                    .append("text")
                    .text(function(d) { return "46-64"; })
                    .attr("text-anchor", "middle")
                    .attr("x", start+(w+b)*4 + w/2)
                    .attr("y", 20)
                    .attr("fill", "DimGray")
                    .attr("font-size", "14px")
                 
                var bar6 = svg.append("rect")
                        .attr("x", function(d,i) { return start + (w+b)*5+i*(w+5) })
                        .attr("y", function(d) { return 0*scale; })
                        .attr("width", w)
                        .on("mouseover", function (d) { showPopoverSM.call(this, d, 6); })
                        .on("mouseout", function (d) { removePopovers(); })
                        .attr("height", function(d) { return 0*scale; })
                        .style("fill", ageColor(5));
                
                bar6.transition().duration(1000)
                        .attr("y", function(d) { return -(d[6]/d[0])*scale; })
                        .attr("height", function(d) { return (d[6]/d[0])*scale; });
                 
                var labels6 = svg
                     .append("text")
                     .text(function(d) { return format( (d[6]/d[0]) * 100 ) + "%"; })
                     .attr("text-anchor", "middle")
                     .attr("x", start + (w+b)*5 + w/2)
                     .attr("y", function(d) { return 0-5; })
                     .attr("fill", "black")
                     .attr("font-size", "14px");
                
                labels6.transition().duration(1000).attr("y", function(d) { return -(d[6]/d[0])*scale - 5; })
                
                svg
                    .append("text")
                    .text(function(d) { return "65+"; })
                    .attr("text-anchor", "middle")
                    .attr("x", start+(w+b)*5 + w/2)
                    .attr("y", 20)
                    .attr("fill", "DimGray")
                    .attr("font-size", "14px")
            
            }
             
             if (selection === "Ethnicity") {                 
                 var l = 3;
                 var start = (2*(r+m) - (w*l + b*(l-1)))/2;
                 start += -(r+m);
                 
                 var q = 15;
             
                 var bar1 = svg.append("rect")
                        .attr("x", function(d,i) { return start+i*(w+5) })
                        .attr("y", function(d) { return 0*scale; })
                        .attr("width", w)
                        .on("mouseover", function (d) { showPopoverSM.call(this, d, 1); })
                        .on("mouseout", function (d) { removePopovers(); })
                        .attr("height", function(d) { return 0*scale; })
                        .style("fill", ethnicityColor(0));
                 
                 bar1.transition().duration(1000)
                        .attr("y", function(d) { return -(d[1]/d[0])*scale; })
                        .attr("height", function(d) { return (d[1]/d[0])*scale; })
                 
                 var labels1 = svg
                     .append("text")
                     .text(function(d) { return format( (d[1]/d[0]) * 100 ) + "%"; })
                     .attr("text-anchor", "middle")
                     .attr("x", start + w/2)
                     .attr("y", function(d) { return 0-5; })
                     .attr("fill", "black")
                     .attr("font-size", "14px");
                 
                 labels1.transition().duration(1000).attr("y", function(d) { return -(d[1]/d[0])*scale - 5; })
                 
                 svg
                    .append("text")
                    .text(function(d) { return "Not Hispanic"; })
                    .attr("text-anchor", "end")
                    .attr("x", start + w/2)
                    .attr("y", q)
                    .attr("fill", "DimGray")
                    .attr("font-size", "14px")
                    .attr("transform", function(d) { return "rotate(-45 -50, 15)" });

                 var bar2 = svg.append("rect")
                        .attr("x", function(d,i) { return start+(w+b)+i*(w+5) })
                        .attr("y", function(d) { return 0*scale; })
                        .attr("width", w)
                        .on("mouseover", function (d) { showPopoverSM.call(this, d, 2); })
                        .on("mouseout", function (d) { removePopovers(); })
                        .attr("height", function(d) { return 0*scale; })
                        .style("fill", ethnicityColor(1));
                 
                 bar2.transition().duration(1000)
                        .attr("y", function(d) { return -(d[2]/d[0])*scale; })
                        .attr("height", function(d) { return (d[2]/d[0])*scale; })
                 
                 var labels2 = svg
                     .append("text")
                     .text(function(d) { return format( (d[2]/d[0]) * 100 ) + "%"; })
                     .attr("text-anchor", "middle")
                     .attr("x", start+(w+b) + w/2)
                     .attr("y", function(d) { return 0-5; })
                     .attr("fill", "black")
                     .attr("font-size", "14px");
                 
                 labels2.transition().duration(1000).attr("y", function(d) { return -(d[2]/d[0])*scale - 5; })
                 
                 svg
                    .append("text")
                    .text(function(d) { return "Hispanic"; })
                    .attr("text-anchor", "end")
                    .attr("x", start+(w+b) + w/2)
                    .attr("y", q)
                    .attr("fill", "DimGray")
                    .attr("font-size", "14px")
                    .attr("transform", function(d) { return "rotate(-45 0, 15)" });
                
                 var bar3 = svg.append("rect")
                        .attr("x", function(d,i) { return start+(w+b)*2+i*(w+5) })
                        .attr("y", function(d) { return 0*scale; })
                        .attr("width", w)
                        .on("mouseover", function (d) { showPopoverSM.call(this, d, 3); })
                        .on("mouseout", function (d) { removePopovers(); })
                        .attr("height", function(d) { return 0*scale; })
                        .style("fill", ethnicityColor(2));
                 
                 bar3.transition().duration(1000)
                        .attr("y", function(d) { return -(d[3]/d[0])*scale; })
                        .attr("height", function(d) { return (d[3]/d[0])*scale; })
                 
                 var labels3 = svg
                     .append("text")
                     .text(function(d) { return format( (d[3]/d[0]) * 100 ) + "%"; })
                     .attr("text-anchor", "middle")
                     .attr("x", start+(w+b)*2 + w/2)
                     .attr("y", function(d) { return 0-5; })
                     .attr("fill", "black")
                     .attr("font-size", "14px");
                 
                 labels3.transition().duration(1000).attr("y", function(d) { return -(d[3]/d[0])*scale - 5; })
                 
                 svg
                    .append("text")
                    .text(function(d) { return "Undefined"; })
                    .attr("text-anchor", "end")
                    .attr("x", start+(w+b)*2 + w/2)
                    .attr("y", q)
                    .attr("fill", "DimGray")
                    .attr("font-size", "14px")
                    .attr("transform", function(d) { return "rotate(-45 50, 15)" }); 
            
            }

        } 
            
        function removePopovers () {
          $('.popover').each(function() {
            $(this).remove();
          }); 
        }

        function showPopover (d) {
          //var format = d3.format('.0f');
          $(this).popover({
            placement: 'right',
            container: 'body',
            trigger: 'manual',
            html : true,
            content: function() { 
              return "total: " + (d*45235).toFixed(0) }
          });
          $(this).popover('show')
        }
            
        function showPopoverSM (d,index) {
          //var format = d3.format('.0f');
          $(this).popover({
            placement: 'right',
            container: 'body',
            trigger: 'manual',
            html : true,
            content: function() { 
              return "total: " + (d[index]).toLocaleString() }
          });
          $(this).popover('show')
        }
                      
      });
    </script>
    </body>
</html>